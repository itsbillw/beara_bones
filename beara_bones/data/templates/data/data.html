{% extends "home/base.html" %}
{% load static %}
{% load plotly_dash %}

{% block header %}
<title>itsbillw - Data</title>
{% endblock %}

{% block content %}
<nav class="navbar navbar-expand data-navbar py-2">
  <div class="data-navbar-inner">
    <span class="navbar-brand text-light mb-0 me-4">Football data</span>
    {% if user.is_staff %}
    <button
      type="button"
      class="btn btn-outline-light btn-sm me-3"
      id="refresh-btn"
      data-url="{% url 'data:data_refresh' %}"
    >
      Refresh pipeline
    </button>
    <span id="refresh-status" class="me-3 small text-light"></span>
    {% endif %}
  </div>
</nav>

<div class="container main-container data-page-content">
  {% plotly_app name="FootballDashboard" ratio=1 %}
</div>

{% if user.is_staff %}
<script>
  (function () {
    var btn = document.getElementById("refresh-btn");
    var status = document.getElementById("refresh-status");
    if (!btn) return;
    btn.addEventListener("click", function () {
      btn.disabled = true;
      status.textContent = "Startingâ€¦";
      fetch(btn.dataset.url, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
      })
        .then(function (r) {
          if (r.status === 202) {
            status.textContent = "Refresh started.";
          } else if (r.status === 409) {
            status.textContent = "Already running.";
          } else {
            status.textContent = "Error " + r.status;
          }
        })
        .catch(function () {
          status.textContent = "Request failed.";
        })
        .finally(function () {
          btn.disabled = false;
        });
    });
  })();
</script>
{% endif %}
{% endblock %}
