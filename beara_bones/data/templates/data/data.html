{% extends "home/base.html" %} {% load static %} {% block header %}
<title>itsbillw - Data</title>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{% endblock %} {% block content %}
<!-- Data page navbar (90% width) -->
<nav class="navbar navbar-expand data-navbar py-2">
  <div class="data-navbar-inner">
    <span class="navbar-brand text-light mb-0 me-4">Football data</span>
    <button
      type="button"
      class="btn btn-outline-light btn-sm me-3"
      id="refresh-btn"
      data-url="{% url 'data:data_refresh' %}"
    >
      Refresh pipeline
    </button>
    <span id="refresh-status" class="me-3 small text-light"></span>
    <div class="dropdown me-3">
      <button
        class="btn btn-outline-light btn-sm dropdown-toggle"
        type="button"
        id="leagueDropdown"
        data-bs-toggle="dropdown"
        aria-expanded="false"
      >
        {{ current_league_name }}
      </button>
      <ul class="dropdown-menu dropdown-menu-dark">
        <li>
          <span class="dropdown-item-text"
            >League {{ current_league }} (current)</span
          >
        </li>
      </ul>
    </div>
    <div class="dropdown">
      <button
        class="btn btn-outline-light btn-sm dropdown-toggle"
        type="button"
        id="seasonDropdown"
        data-bs-toggle="dropdown"
        aria-expanded="false"
      >
        {{ current_season }}
      </button>
      <ul class="dropdown-menu dropdown-menu-dark">
        <li><span class="dropdown-item-text">Season (current)</span></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container main-container data-page-content">
  <div id="dashboard-content">
    {% if loading %}
    <div class="text-center py-5 text-light" aria-live="polite">
      <div class="spinner-border mb-3" role="status">
        <span class="visually-hidden">Loading…</span>
      </div>
      <p class="mb-0">Loading chart and table…</p>
    </div>
    <script>
      (function () {
        var content = document.getElementById("dashboard-content");
        function runInjectedScripts(container) {
          container.querySelectorAll("script").forEach(function (oldScript) {
            var script = document.createElement("script");
            if (oldScript.src) script.src = oldScript.src;
            else script.textContent = oldScript.textContent;
            oldScript.parentNode.replaceChild(script, oldScript);
          });
        }
        fetch('{% url "data:data_fragment" %}')
          .then(function (r) {
            return r.text();
          })
          .then(function (html) {
            content.innerHTML = html;
            runInjectedScripts(content);
          })
          .catch(function () {
            content.innerHTML =
              '<div class="alert alert-warning">Failed to load data.</div>';
          });
      })();
    </script>
    {% endif %}
  </div>
</div>

<script>
  (function () {
    var btn = document.getElementById("refresh-btn");
    var status = document.getElementById("refresh-status");
    if (!btn) return;
    btn.addEventListener("click", function () {
      btn.disabled = true;
      status.textContent = "Starting…";
      fetch(btn.dataset.url, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
      })
        .then(function (r) {
          if (r.status === 202) {
            status.textContent = "Refresh started.";
          } else if (r.status === 409) {
            status.textContent = "Already running.";
          } else {
            status.textContent = "Error " + r.status;
          }
        })
        .catch(function () {
          status.textContent = "Request failed.";
        })
        .finally(function () {
          btn.disabled = false;
        });
    });
  })();
</script>
{% endblock %}
